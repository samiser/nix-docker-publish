name: 'Nix Docker Image Publisher'
description: 'Build and publish Docker images from Nix flake outputs'
branding:
  icon: 'package'
  color: 'blue'

inputs:
  image-name:
    description: 'Image name (defaults to repository name)'
    required: false
    default: ${{ github.repository }}
  flake-output:
    description: 'Nix flake output path for the Docker image'
    required: false
    default: '.#dockerImage'
  source-tag:
    description: 'Nix source version tag'
    required: false
    default: 'v0.31.0'
  github-token:
    description: 'GitHub token for registry authentication'
    required: true
  tag-latest:
    description: 'Whether to tag as latest on main/master branch'
    required: false
    default: 'true'

outputs:
  image:
    description: 'Full image name with registry'
    value: ${{ steps.push.outputs.image }}
  digest:
    description: 'Image digest'
    value: ${{ steps.push.outputs.digest }}

runs:
  using: 'composite'
  steps:
    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@v16
      with:
        source-tag: ${{ inputs.source-tag }}

    - name: Build Docker image
      id: build
      shell: bash
      run: |
        echo "Building Nix flake output: ${{ inputs.flake-output }}"
        nix build ${{ inputs.flake-output }}

        if [ ! -f result ]; then
          echo "Error: Nix build did not produce a 'result' symlink"
          exit 1
        fi

        echo "Loading Docker image from Nix build result"
        LOAD_OUTPUT=$(docker load < result)
        echo "${LOAD_OUTPUT}"

        LOADED_IMAGE=$(echo "${LOAD_OUTPUT}" | grep -oP 'Loaded image: \K.*')
        echo "loaded-image=${LOADED_IMAGE}" >> $GITHUB_OUTPUT

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ inputs.github-token }}
    
    - name: Tag and push image
      id: push
      shell: bash
      run: |
        LOADED_IMAGE="${{ steps.build.outputs.loaded-image }}"
        echo "Loaded image: ${LOADED_IMAGE}"
        
        IMAGE_NAME=$(echo "ghcr.io/${{ inputs.image-name }}" | tr '[:upper:]' '[:lower:]')
        echo "Target image name: ${IMAGE_NAME}"
        
        echo "Tagging and pushing ${IMAGE_NAME}:${{ github.sha }}"
        docker tag ${LOADED_IMAGE} ${IMAGE_NAME}:${{ github.sha }}
        docker push ${IMAGE_NAME}:${{ github.sha }}
        
        if [ "${{ inputs.tag-latest }}" = "true" ]; then
          if [ "${{ github.ref }}" = "refs/heads/master" ] || [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "Tagging and pushing ${IMAGE_NAME}:latest"
            docker tag ${LOADED_IMAGE} ${IMAGE_NAME}:latest
            docker push ${IMAGE_NAME}:latest
          fi
        fi
        
        DIGEST=$(docker inspect ${IMAGE_NAME}:${{ github.sha }} --format='{{index .RepoDigests 0}}' | cut -d'@' -f2)
        
        echo "image=${IMAGE_NAME}" >> $GITHUB_OUTPUT
        echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
